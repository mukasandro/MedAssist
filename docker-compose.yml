services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      DOTNET_ENVIRONMENT: Development
      ConnectionStrings__Default: Host=postgres;Port=5432;Database=medassist;Username=medassist;Password=medassist
      Cors__Origins: http://localhost:4173,http://127.0.0.1:4173
      Auth__Jwt__SigningKey: ${AUTH_JWT_SIGNING_KEY:-dev-only-change-this-signing-key-32+}
      Auth__Telegram__BotToken: ${AUTH_TELEGRAM_BOT_TOKEN:-}
      Auth__Service__ApiKey: ${AUTH_SERVICE_API_KEY:-}
    ports:
      - "5555:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/registration"]
      interval: 30s
      timeout: 5s
      retries: 3

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: medassist
      POSTGRES_PASSWORD: medassist
      POSTGRES_DB: medassist
    ports:
      # Хостовый порт вынесен на 5433, чтобы не конфликтовать с локальным Postgres
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U medassist"]
      interval: 10s
      timeout: 5s
      retries: 5


  llm-gateway:
    build:
      context: .
      dockerfile: Dockerfile.llm-gateway
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      DOTNET_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8090
      LlmGateway__DeepSeek__BaseUrl: ${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      LlmGateway__DeepSeek__ApiKey: ${DEEPSEEK_API_KEY:?DEEPSEEK_API_KEY is required}
      LlmGateway__DeepSeek__DefaultModel: ${DEEPSEEK_DEFAULT_MODEL:-deepseek-chat}
      LlmGateway__RequestTimeoutMs: ${DEEPSEEK_REQUEST_TIMEOUT_MS:-60000}
    ports:
      - "8090:8090"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://muk.i234.me:5555}
        VITE_LLM_GATEWAY_URL: ${VITE_LLM_GATEWAY_URL:-http://muk.i234.me:8090}
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://muk.i234.me:5555}
      VITE_LLM_GATEWAY_URL: ${VITE_LLM_GATEWAY_URL:-http://muk.i234.me:8090}
    ports:
      - "4173:80"
    depends_on:
      - api
      - llm-gateway

volumes:
  postgres_data:
